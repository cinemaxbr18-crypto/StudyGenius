<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>StudyGenius Pro - Estudo Ilimitado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Estilos base para App Nativo */
        html, body {
            height: 100%;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .no-select { user-select: none; -webkit-user-select: none; }
        
        /* Ajuste para input range se houver */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #4f46e5; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SISTEMA DE CHAVES (Key Rotation) ---
        // Lista expandida com as novas chaves fornecidas
        const API_POOL = [
            // Novas chaves fornecidas
            "AIzaSyDqSbruO1luTApE8Gbo03S94LqWqHxtfOY", "AIzaSyCpE-yEXBKNw5Yp4DX0o25P0IAvWXu41yw",
            "AIzaSyCOISNKNIrrRYsiI2l4A1FA8BstXnRh43s", "AIzaSyDP-HBkkPNkh_762TadkZFeUuoGjWTWGJk",
            "AIzaSyAQOUPVIxLfMtpqC40SMQDu1rp46iCaFp4", "AIzaSyCwLoaIS1pYBjwYl2y7IdVSZIH1UhFlwFg",
            "AIzaSyDtzmO462BY-Z6NgahHf3AJIt1dRZb9QXc", "AIzaSyA9qsJfw4hzPc8s8AFaBJ7sU1kD3wVkVm4",
            "AIzaSyDllfSG-OOrqTNvu1ccQZy0RUnf108AK-A", "AIzaSyB8H6yjZc0VAJ-6Jq5_gQcMqIqvkOWEVKQ",
            "AIzaSyAVe7YLROoFMgJqvBh1lfPa82JPE6KXWd8", "AIzaSyC4tmuBVhPorFLGgjGKHnYthywr36BI4p0",
            "AIzaSyCnTYFTkPZ9bMOJuvRfaSSGGPExRUsVnW8", "AIzaSyCdSkyEfyJQCsR0XMXee99WR9kAZRY23Es",
            "AIzaSyD0P4awwiLs19wDVukDQUEn_ksmcpoyQGY", "AIzaSyDGabv5AW5OsySJESb31Aowd5_8-horjOs",
            "AIzaSyBZLtfl2iSmpbq4OtOJ9Pqpde9Yuzu0978", "AIzaSyCFQJf1ioGhAh3xRBFiza287o0iYgtlIIk",
            "AIzaSyCrb4zKcN96c03cQ__3bQcucaJW-ohBxWE", "AIzaSyC6stOq7USiFmgQODiUDP6A6hH2MtO7Qtg",
            // Chaves antigas (backup)
            "AIzaSyA5wncx6i6OliJUroEn0v-e3dXOoMeWseg", "AIzaSyApWJ1zkLMuyWPFltHCa7hK12nmWVDKKCs",
            "AIzaSyD7r5fr16axCD8Bq6znpgPUX91d7xo_iPg", "AIzaSyDAF4PFRRnI63wk4TO3DvA5YDb_h3_-sdg",
            "AIzaSyCkv7LqGUSK7-ER0V7rEMdo_Xo4sw4VnBs", "AIzaSyDlRhKn0myaR8wbGoerPguJhXU_1J2Ay6Y"
        ];
        
        const API_STORAGE_KEY = 'studygenius_user_key';
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025"; 

        // --- CONSTANTES DE LIMITE ---
        const LIMITS = {
            MAIN: 20, // Perguntas/Gera√ß√µes (Quiz/Flashcards)
            TUTOR: 30 // Mensagens do Chat
        };

        // --- √çCONES ---
        const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            Book: (p) => <Icon {...p} d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />,
            Brain: (p) => <Icon {...p} d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" />,
            Lightbulb: (p) => <Icon {...p} d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.8-6-6-6S6 4.8 6 8c0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5 M9 18h6 M10 22h4" />,
            Check: (p) => <Icon {...p} d="M20 6L9 17l-5-5" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            ArrowRight: (p) => <Icon {...p} d="M5 12h14M12 5l7 7-7 7" />,
            ArrowLeft: (p) => <Icon {...p} d="M19 12H5M12 19l-7-7 7-7" />,
            Loader: (p) => <Icon {...p} d="M21 12a9 9 0 1 1-6.219-8.56" />,
            ChatBubble: (p) => <Icon {...p} d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />,
            Send: (p) => <Icon {...p} d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />,
            Maximize: (p) => <Icon {...p} d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />,
            Minimize: (p) => <Icon {...p} d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7" />,
            Download: (p) => <Icon {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            Settings: (p) => <Icon {...p} d="M12.22 2h-.44a2 2 0 0 1-2 2 2 2 0 0 0-2 2 2 2 0 0 1-2 2 2 2 0 0 0-2 2 2 2 0 0 1-2 2v.44a2 2 0 0 1 2 2 2 2 0 0 0 2 2 2 2 0 0 1 2 2 2 2 0 0 0 2 2 2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2 2 2 0 0 0 2-2 2 2 0 0 1 2-2 2 2 0 0 0 2-2 2 2 0 0 1-2-2v-.44a2 2 0 0 1-2-2 2 2 0 0 0-2-2 2 2 0 0 1-2-2 2 2 0 0 0-2-2 2 2 0 0 1-2-2z" />,
            Alert: (p) => <Icon {...p} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />,
            Lock: (p) => <Icon {...p} d="M12 2a4 4 0 0 0-4 4v4H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4zm0 12a2 2 0 1 1 0 4 2 2 0 0 1 0-4z" />
        };

        // --- L√ìGICA DE API COM ROTA√á√ÉO ---
        const callGemini = async (prompt, expectJson = false) => {
            const userKey = localStorage.getItem(API_STORAGE_KEY);
            // Embaralha o pool para distribui√ß√£o de carga
            let keysToTry = userKey ? [userKey] : [...API_POOL].sort(() => Math.random() - 0.5);
            
            const generationConfig = expectJson ? { response_mime_type: "application/json" } : {};
            let lastError = null;

            for (const apiKey of keysToTry) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: generationConfig
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    return text;

                } catch (error) {
                    lastError = error;
                    continue; // Tenta a pr√≥xima chave
                }
            }
            throw lastError || new Error("Todas as chaves falharam. Tente mais tarde.");
        };

        const parseJSONFromAI = (text) => {
            if (!text) return null;
            try {
                return JSON.parse(text);
            } catch (e) {
                try {
                    const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```([\s\S]*?)```/) || text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                    if (jsonMatch) return JSON.parse(jsonMatch[1] || jsonMatch[0]);
                    return null;
                } catch (e2) {
                    console.error("JSON Parse Error:", e2, text);
                    return null;
                }
            }
        };

        // --- HOOK DE LIMITES ---
        const useUsageTracker = () => {
            const [mainUsage, setMainUsage] = useState(0);
            const [tutorUsage, setTutorUsage] = useState(0);

            useEffect(() => {
                const storedMain = parseInt(localStorage.getItem('sg_main_usage') || '0');
                const storedTutor = parseInt(localStorage.getItem('sg_tutor_usage') || '0');
                setMainUsage(storedMain);
                setTutorUsage(storedTutor);
            }, []);

            const incrementMain = () => {
                const newVal = mainUsage + 1;
                setMainUsage(newVal);
                localStorage.setItem('sg_main_usage', newVal);
            };

            const incrementTutor = () => {
                const newVal = tutorUsage + 1;
                setTutorUsage(newVal);
                localStorage.setItem('sg_tutor_usage', newVal);
            };

            return { 
                mainUsage, 
                tutorUsage, 
                incrementMain, 
                incrementTutor,
                mainRemaining: Math.max(0, LIMITS.MAIN - mainUsage),
                tutorRemaining: Math.max(0, LIMITS.TUTOR - tutorUsage)
            };
        };

        // --- COMPONENTES UI ---
        
        const MaintenanceScreen = ({ errorMsg, onRetry }) => {
            const [newKey, setNewKey] = useState('');
            const handleSave = () => {
                if(newKey.length > 10) {
                    localStorage.setItem(API_STORAGE_KEY, newKey);
                    onRetry();
                }
            };
            return (
                <div className="fixed inset-0 bg-slate-50 z-[100] flex items-center justify-center p-6 animate-in">
                    <div className="bg-white max-w-md w-full rounded-3xl shadow-2xl p-8 text-center border border-slate-200">
                        <div className="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icons.Alert className="w-10 h-10 text-amber-600" />
                        </div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">Sistema Inst√°vel</h2>
                        <p className="text-slate-500 mb-6 text-sm">
                            Houve um erro na conex√£o com a IA.
                            <br/><span className="text-xs bg-red-50 text-red-500 px-2 py-1 rounded mt-2 inline-block font-mono max-w-full truncate">{errorMsg}</span>
                        </p>
                        <div className="bg-indigo-50 p-4 rounded-2xl mb-4 text-left border border-indigo-100">
                            <label className="text-xs font-bold text-indigo-800 uppercase block mb-2">Solu√ß√£o Definitiva</label>
                            <input value={newKey} onChange={e => setNewKey(e.target.value)} placeholder="Cole sua chave AIza aqui..." className="w-full p-3 rounded-xl border border-indigo-200 text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            <button onClick={handleSave} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all">Salvar Chave</button>
                        </div>
                        <button onClick={onRetry} className="text-slate-400 font-bold text-sm hover:text-indigo-600">Tentar Novamente</button>
                    </div>
                </div>
            );
        };

        const ChatTutor = ({ currentTopic, usageTracker }) => {
            const [mode, setMode] = useState('closed'); 
            const [messages, setMessages] = useState([{ role: 'ai', text: 'Ol√°! Sou seu tutor. Posso ajudar?' }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef();

            useEffect(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, mode]);

            const handleSend = async () => {
                if(!input.trim() || loading) return;
                
                if (usageTracker.tutorRemaining <= 0) {
                    setMessages(p => [...p, { role: 'ai', text: "üîí **Limite do Tutor Atingido.** Voc√™ usou suas 30 mensagens gratuitas." }]);
                    return;
                }

                const text = input;
                setInput('');
                setMessages(p => [...p, { role: 'user', text }]);
                setLoading(true);
                usageTracker.incrementTutor();

                const prompt = `Atue como professor particular. T√≥pico: "${currentTopic || 'Geral'}". Usu√°rio perguntou: "${text}". Responda de forma curta, direta e did√°tica em Markdown.`;
                
                try {
                    const res = await callGemini(prompt, false); 
                    setMessages(p => [...p, { role: 'ai', text: res }]);
                } catch(e) {
                    setMessages(p => [...p, { role: 'ai', text: "Erro de conex√£o. Tente novamente." }]);
                } finally { setLoading(false); }
            };

            if(mode === 'closed') return (
                <div className="fixed bottom-6 right-6 z-50">
                    <button onClick={() => setMode('popup')} className="bg-indigo-600 text-white p-4 rounded-full shadow-xl hover:scale-110 transition-all active:scale-95 no-select relative">
                        <Icons.ChatBubble className="w-6 h-6" />
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-white">{usageTracker.tutorRemaining}</span>
                    </button>
                </div>
            );

            const isFull = mode === 'full';
            const containerClass = isFull 
                ? "fixed inset-0 z-[60] bg-white flex flex-col animate-in"
                : "fixed bottom-6 right-6 z-[60] w-full max-w-[350px] h-[500px] bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden animate-slide-up mx-4 md:mx-0 right-0 md:right-6 bottom-0 md:bottom-6 mb-4 md:mb-6";

            return (
                <div className={containerClass}>
                    <div className="bg-indigo-600 p-4 text-white flex justify-between items-center shrink-0 no-select">
                        <div className="flex items-center gap-2 font-bold"><Icons.Brain className="w-5 h-5"/> Tutor IA <span className="opacity-50 text-xs">({usageTracker.tutorRemaining} restam)</span></div>
                        <div className="flex gap-2">
                            <button onClick={() => setMode(isFull ? 'popup' : 'full')} className="p-1 hover:bg-white/20 rounded">
                                {isFull ? <Icons.Minimize className="w-5 h-5"/> : <Icons.Maximize className="w-5 h-5"/>}
                            </button>
                            <button onClick={() => setMode('closed')} className="p-1 hover:bg-white/20 rounded"><Icons.X className="w-5 h-5"/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 custom-scroll">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border text-slate-800 rounded-bl-none shadow-sm'}`}>
                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(m.text) }} />
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 italic">Digitando...</div>}
                        <div ref={scrollRef} />
                    </div>
                    <div className="p-3 border-t bg-white flex gap-2 shrink-0 pb-safe">
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder="D√∫vida..." disabled={usageTracker.tutorRemaining <= 0} className="flex-1 bg-slate-100 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50" />
                        <button onClick={handleSend} disabled={loading || usageTracker.tutorRemaining <= 0} className="bg-indigo-600 text-white p-2 px-4 rounded-xl hover:bg-indigo-700 disabled:bg-slate-300 transition-colors"><Icons.Send className="w-5 h-5"/></button>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function StudyGenius() {
            const [view, setView] = useState('home');
            const [topics, setTopics] = useState('');
            const [loading, setLoading] = useState(false);
            const [maintenance, setMaintenance] = useState(null);
            const usageTracker = useUsageTracker();
            
            const [quizConfig, setQuizConfig] = useState({ count: 5, difficulty: 'Intermedi√°rio' });
            
            const [flashcards, setFlashcards] = useState([]);
            const [quizData, setQuizData] = useState([]);
            const [quizResult, setQuizResult] = useState(null);
            const [analysis, setAnalysis] = useState(null);
            
            const [currentCard, setCurrentCard] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [answers, setAnswers] = useState({});
            const [hints, setHints] = useState({});

            useEffect(() => { window.scrollTo(0, 0); }, [view]);

            const handleError = (e) => {
                setLoading(false);
                if (e.message.includes('429') || e.message.includes('403') || e.message.includes('400')) {
                    setMaintenance(e.message);
                } else {
                    alert(`Erro de conex√£o: ${e.message}`);
                }
            };

            const checkLimit = () => {
                if (usageTracker.mainRemaining <= 0) {
                    alert("Limite de 20 gera√ß√µes atingido neste dispositivo.");
                    return false;
                }
                return true;
            };

            const generateFlashcards = async () => {
                if(!topics.trim()) return alert("Digite um t√≥pico!");
                if(!checkLimit()) return;
                
                setLoading(true);
                const prompt = `Crie 8 flashcards educativos sobre "${topics}". Retorne APENAS um Array JSON puro: [{"front": "pergunta", "back": "resposta"}].`;
                try {
                    const text = await callGemini(prompt, true);
                    const json = parseJSONFromAI(text);
                    if(json && Array.isArray(json)) { 
                        setFlashcards(json); 
                        setCurrentCard(0); 
                        setFlipped(false); 
                        setView('flashcards');
                        usageTracker.incrementMain();
                    } else throw new Error("Formato inv√°lido.");
                } catch(e) { handleError(e); }
                finally { setLoading(false); }
            };

            const generateQuiz = async () => {
                if(!topics.trim()) return alert("Digite um t√≥pico!");
                if(!checkLimit()) return;

                setLoading(true);
                const prompt = `Crie um quiz com ${quizConfig.count} perguntas n√≠vel ${quizConfig.difficulty} sobre "${topics}". Retorne JSON: [{"question": "txt", "options": ["A","B","C","D"], "correctIndex": 0, "hint": "dica", "explanation": "explica√ß√£o"}]`;
                
                try {
                    const text = await callGemini(prompt, true);
                    const json = parseJSONFromAI(text);
                    if(json && Array.isArray(json)) { 
                        setQuizData(json); 
                        setAnswers({}); 
                        setHints({}); 
                        setView('quiz'); 
                        usageTracker.incrementMain();
                    } else throw new Error("Erro no quiz.");
                } catch(e) { handleError(e); }
                finally { setLoading(false); }
            };

            const submitQuiz = async () => {
                let score = 0;
                const report = quizData.map((q, i) => {
                    const correct = answers[i] === q.correctIndex;
                    if(correct) score++;
                    return { q: q.question, correct, user: q.options[answers[i]], correctAns: q.options[q.correctIndex], explanation: q.explanation };
                });
                setQuizResult({ score, total: quizData.length, report });
                setLoading(true);

                const prompt = `Analise: T√≥pico "${topics}", Nota ${score}/${quizData.length}. Retorne JSON: {"feedback": "msg", "weakPoints": ["p1", "p2"], "studyPlan": "plano"}`;
                
                try {
                    const text = await callGemini(prompt, true);
                    const json = parseJSONFromAI(text);
                    setAnalysis(json || { feedback: "Bom esfor√ßo!", weakPoints: [], studyPlan: "Revise o conte√∫do." });
                    setView('analysis');
                } catch(e) { handleError(e); } 
                finally { setLoading(false); }
            };

            const downloadReport = () => {
                const content = `RELAT√ìRIO STUDYGENIUS\nT√≥pico: ${topics}\nNota: ${quizResult.score}/${quizResult.total}\n\nFEEDBACK:\n${analysis.feedback}\n\nPLANO:\n${analysis.studyPlan}`;
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio-${topics}.txt`;
                a.click();
            };

            if (maintenance) return <MaintenanceScreen errorMsg={maintenance} onRetry={() => setMaintenance(null)} />;

            return (
                <div className="min-h-screen pb-20 flex flex-col items-center w-full">
                    {loading && (
                        <div className="fixed inset-0 bg-white/90 z-[90] flex flex-col items-center justify-center backdrop-blur-sm animate-in no-select">
                            <Icons.Loader className="w-12 h-12 text-indigo-600 animate-spin mb-4" />
                            <p className="font-bold text-indigo-900 animate-pulse">Gerando Conte√∫do Inteligente...</p>
                        </div>
                    )}

                    <header className="h-16 bg-white border-b sticky top-0 z-40 flex items-center px-6 justify-between shadow-sm w-full max-w-4xl mx-auto no-select">
                        <div className="flex items-center gap-2 font-black text-xl text-slate-800 cursor-pointer active:opacity-70 transition-opacity" onClick={() => setView('home')}>
                            <span className="bg-indigo-600 text-white p-1 rounded-lg"><Icons.Book className="w-5 h-5"/></span>
                            StudyGenius <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">PRO</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="hidden md:flex flex-col items-end text-[10px] font-bold text-slate-400 uppercase leading-tight">
                                <span>Gera√ß√µes: {usageTracker.mainRemaining}</span>
                                <span>Chat: {usageTracker.tutorRemaining}</span>
                            </div>
                            <button onClick={() => setMaintenance('Configura√ß√£o Manual')} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 active:bg-slate-200">
                                <Icons.Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    <main className="w-full max-w-4xl p-4 md:p-6 flex-1 flex flex-col">
                        {view === 'home' && (
                            <div className="py-6 md:py-10 animate-in space-y-6 md:space-y-8 flex-1 flex flex-col justify-center">
                                <div className="text-center no-select">
                                    <h1 className="text-5xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500 pb-2">Seu Mentor IA</h1>
                                    <p className="text-slate-500 text-lg font-medium">O que vamos aprender hoje?</p>
                                    {usageTracker.mainRemaining <= 0 && <p className="text-red-500 font-bold mt-2 bg-red-50 inline-block px-3 py-1 rounded">Limite di√°rio de gera√ß√µes atingido.</p>}
                                </div>

                                <div className="bg-white p-5 md:p-6 rounded-3xl shadow-xl border border-indigo-50 relative overflow-hidden">
                                    <textarea 
                                        value={topics} 
                                        onChange={e => setTopics(e.target.value)} 
                                        placeholder="Ex: Revolu√ß√£o Industrial, F√≠sica Qu√¢ntica, Verbos em Ingl√™s..." 
                                        className="w-full h-32 p-4 rounded-xl border border-slate-200 focus:ring-4 focus:ring-indigo-100 outline-none resize-none text-lg mb-4 bg-slate-50"
                                    />
                                    <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                                        <div>
                                            <label className="text-[10px] font-black uppercase text-slate-400 no-select">Quest√µes</label>
                                            <select value={quizConfig.count} onChange={e => setQuizConfig({...quizConfig, count: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg font-bold border focus:outline-none">
                                                <option value="5">5 Perguntas</option><option value="10">10 Perguntas</option><option value="15">15 Perguntas</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black uppercase text-slate-400 no-select">N√≠vel</label>
                                            <select value={quizConfig.difficulty} onChange={e => setQuizConfig({...quizConfig, difficulty: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg font-bold border focus:outline-none">
                                                <option value="Iniciante">F√°cil</option><option value="Intermedi√°rio">M√©dio</option><option value="Avan√ßado">Dif√≠cil</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 no-select">
                                    <button onClick={() => generateFlashcards()} disabled={usageTracker.mainRemaining <= 0} className="p-5 bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 active:bg-indigo-100 rounded-2xl flex items-center justify-center gap-3 font-bold text-slate-700 transition-all shadow-sm disabled:opacity-50 disabled:grayscale">
                                        {usageTracker.mainRemaining > 0 ? <Icons.Book className="text-indigo-600 w-6 h-6"/> : <Icons.Lock className="w-6 h-6"/>}
                                        <span>Gerar Flashcards</span>
                                    </button>
                                    <button onClick={generateQuiz} disabled={usageTracker.mainRemaining <= 0} className="p-5 bg-white border-2 border-blue-100 hover:border-blue-500 hover:bg-blue-50 active:bg-blue-100 rounded-2xl flex items-center justify-center gap-3 font-bold text-slate-700 transition-all shadow-sm disabled:opacity-50 disabled:grayscale">
                                        {usageTracker.mainRemaining > 0 ? <Icons.Brain className="text-blue-600 w-6 h-6"/> : <Icons.Lock className="w-6 h-6"/>}
                                        <span>Iniciar Quiz</span>
                                    </button>
                                </div>
                                <div className="text-center text-xs text-slate-400 font-medium">
                                    Cr√©ditos Restantes: {usageTracker.mainRemaining} / {LIMITS.MAIN}
                                </div>
                            </div>
                        )}

                        {view === 'flashcards' && (
                            <div className="py-6 md:py-10 flex flex-col items-center gap-6 md:gap-8 animate-in h-full justify-center">
                                <div className="w-full flex justify-between items-center no-select">
                                    <button onClick={() => setView('home')} className="flex items-center gap-2 font-bold text-slate-400 hover:text-indigo-600 active:text-indigo-800 p-2 -ml-2"><Icons.ArrowLeft className="w-5 h-5"/> Voltar</button>
                                    <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase">{currentCard + 1} / {flashcards.length}</span>
                                </div>
                                <div className="w-full max-w-lg aspect-[3/4] md:aspect-[3/2] perspective-1000 cursor-pointer group no-select" onClick={() => setFlipped(!flipped)}>
                                    <div className={`relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl ${flipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 bg-white backface-hidden rounded-3xl p-8 flex items-center justify-center text-center border-2 border-slate-200"><p className="text-2xl font-bold text-slate-800 select-text">{flashcards[currentCard].front}</p></div>
                                        <div className="absolute inset-0 bg-indigo-600 backface-hidden rotate-y-180 rounded-3xl p-8 flex items-center justify-center text-center text-white"><p className="text-xl font-medium leading-relaxed select-text">{flashcards[currentCard].back}</p></div>
                                    </div>
                                </div>
                                <div className="flex gap-4 no-select w-full justify-center">
                                    <button disabled={currentCard===0} onClick={() => {setCurrentCard(c=>c-1); setFlipped(false)}} className="p-4 bg-white rounded-full shadow-lg disabled:opacity-50 active:scale-95 transition-transform"><Icons.ArrowLeft className="w-6 h-6 text-slate-700"/></button>
                                    <button onClick={() => setFlipped(!flipped)} className="px-8 bg-slate-800 text-white rounded-full font-bold shadow-lg active:scale-95 transition-transform">Virar</button>
                                    <button disabled={currentCard===flashcards.length-1} onClick={() => {setCurrentCard(c=>c+1); setFlipped(false)}} className="p-4 bg-white rounded-full shadow-lg disabled:opacity-50 active:scale-95 transition-transform"><Icons.ArrowRight className="w-6 h-6 text-slate-700"/></button>
                                </div>
                            </div>
                        )}

                        {view === 'quiz' && (
                            <div className="py-6 space-y-6 pb-24 animate-in">
                                <button onClick={() => setView('home')} className="flex items-center gap-2 font-bold text-slate-400 hover:text-red-500 no-select p-2 -ml-2"><Icons.ArrowLeft className="w-5 h-5"/> Cancelar Quiz</button>
                                {quizData.map((q, i) => (
                                    <div key={i} className="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <h3 className="font-bold text-lg mb-4 flex gap-3"><span className="bg-slate-100 w-8 h-8 rounded flex items-center justify-center text-sm shrink-0">{i+1}</span> {q.question}</h3>
                                        <div className="grid gap-2 pl-0 md:pl-11">
                                            {q.options.map((opt, idx) => (
                                                <button key={idx} onClick={() => setAnswers(p => ({...p, [i]: idx}))} className={`text-left p-3 rounded-xl border transition-all active:scale-[0.99] ${answers[i] === idx ? 'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold' : 'hover:bg-slate-50'}`}>{opt}</button>
                                            ))}
                                        </div>
                                        <div className="md:ml-11 mt-3">
                                            {!hints[i] ? <button onClick={() => setHints(p => ({...p, [i]: true}))} className="text-xs font-bold text-amber-500 hover:text-amber-600 flex items-center gap-1"><Icons.Lightbulb className="w-4 h-4"/> Ver Dica</button> 
                                            : <div className="text-sm text-amber-700 bg-amber-50 p-3 rounded-lg mt-2 animate-in flex gap-2"><Icons.Lightbulb className="w-4 h-4 shrink-0 mt-0.5"/> <span>{q.hint}</span></div>}
                                        </div>
                                    </div>
                                ))}
                                <div className="fixed bottom-0 left-0 w-full bg-white p-4 border-t flex justify-center z-30 pb-safe">
                                    <button onClick={submitQuiz} className="w-full max-w-md bg-indigo-600 text-white font-bold text-lg py-4 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2"><Icons.Check className="w-6 h-6" /> Finalizar Quiz</button>
                                </div>
                            </div>
                        )}

                        {view === 'analysis' && analysis && (
                            <div className="py-6 md:py-10 animate-in pb-20">
                                <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200 mb-6">
                                    <div className="bg-slate-800 p-8 text-center text-white relative overflow-hidden">
                                        <div className="relative z-10">
                                            <h2 className="text-3xl font-black mb-1">Resultado</h2>
                                            <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 my-4">{Math.round((quizResult.score / quizResult.total) * 100)}%</div>
                                            <p className="opacity-80 font-medium">{quizResult.score} de {quizResult.total} corretas</p>
                                        </div>
                                    </div>
                                    
                                    <div className="p-6 md:p-8 space-y-6">
                                        <div className="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-xl">
                                            <h3 className="font-bold text-indigo-900 flex items-center gap-2 mb-2"><Icons.ChatBubble className="w-5 h-5"/> Feedback</h3>
                                            <p className="text-indigo-800 leading-relaxed">{analysis.feedback}</p>
                                        </div>
                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2 text-sm uppercase">Pontos Fracos</h3>
                                                <ul className="space-y-2">{analysis.weakPoints?.map((p, i) => <li key={i} className="flex gap-2 text-sm text-slate-600 bg-red-50 p-2 rounded-lg"><span className="text-red-500 font-bold">‚Ä¢</span> {p}</li>)}</ul>
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2 text-sm uppercase">Plano de Estudo</h3>
                                                <div className="text-sm text-slate-600 bg-green-50 p-3 rounded-xl border border-green-100 whitespace-pre-wrap">{analysis.studyPlan}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 border-t flex gap-3 justify-center">
                                        <button onClick={() => setView('home')} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors">Voltar</button>
                                        <button onClick={downloadReport} className="px-6 py-3 rounded-xl font-bold bg-slate-800 text-white hover:bg-black shadow-lg flex items-center gap-2"><Icons.Download className="w-5 h-5"/> Baixar</button>
                                    </div>
                                </div>
                                <h3 className="font-bold text-slate-400 uppercase text-xs mb-4 text-center tracking-widest">Gabarito</h3>
                                <div className="space-y-4">
                                    {quizResult.report.map((item, i) => (
                                        <div key={i} className={`bg-white p-5 rounded-xl border-l-4 shadow-sm ${item.correct ? 'border-green-500' : 'border-red-500'}`}>
                                            <div className="flex justify-between items-start mb-2"><p className="font-bold text-slate-800 pr-4">{i+1}. {item.q}</p>{item.correct ? <Icons.Check className="w-6 h-6 text-green-500 shrink-0"/> : <Icons.X className="w-6 h-6 text-red-500 shrink-0"/>}</div>
                                            <div className="text-sm space-y-1 mb-3"><p className={`${item.correct ? 'text-green-700' : 'text-red-600 line-through opacity-70'}`}>Sua resp: {item.user || "N/A"}</p>{!item.correct && <p className="text-green-700 font-bold">Correta: {item.correctAns}</p>}</div>
                                            <p className="text-xs text-slate-500 bg-slate-50 p-2 rounded italic border border-slate-100">Explica√ß√£o: {item.explanation}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                    <ChatTutor currentTopic={topics} usageTracker={usageTracker} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudyGenius />);
    </script>
</body>
</html>
