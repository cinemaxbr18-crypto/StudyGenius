<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyGenius Pro - Estudo Blindado</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Marked para Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURA√á√ÉO DE SEGURAN√áA ---
        const DEFAULT_API_KEY = "AIzaSyBPOB1T30kPvWthvv9Kd275pu3jCTFLnJ0"; 
        const getApiKey = () => localStorage.getItem('user_api_key') || DEFAULT_API_KEY;

        // --- √çCONES SVG ---
        const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            Book: (p) => <Icon {...p} d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />,
            Brain: (p) => <Icon {...p} d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" />,
            Check: (p) => <Icon {...p} d="M20 6L9 17l-5-5" />,
            X: (p) => <Icon {...p} d="M18 6L6 18M6 6l12 12" />,
            ArrowLeft: (p) => <Icon {...p} d="M19 12H5M12 19l-7-7 7-7" />,
            ArrowRight: (p) => <Icon {...p} d="M5 12h14M12 5l7 7-7 7" />,
            Loader: (p) => <Icon {...p} d="M21 12a9 9 0 1 1-6.219-8.56" />,
            ChatBubble: (p) => <Icon {...p} d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />,
            Send: (p) => <Icon {...p} d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />,
            Maximize: (p) => <Icon {...p} d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />,
            Minimize: (p) => <Icon {...p} d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7" />,
            Download: (p) => <Icon {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            Lightbulb: (p) => <Icon {...p} d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.8-6-6-6S6 4.8 6 8c0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5 M9 18h6 M10 22h4" />,
            Alert: (p) => <Icon {...p} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />
        };

        // --- CHAMADAS DE API COM TRATAMENTO DE ERRO ---
        const callGemini = async (prompt) => {
            const currentKey = getApiKey();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || response.status);
                }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        };

        const parseJSONFromAI = (text) => {
            try {
                const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```([\s\S]*?)```/);
                return JSON.parse(jsonMatch ? jsonMatch[1] : text);
            } catch (e) { return null; }
        };

        // --- TELA DE MANUTEN√á√ÉO / ERRO DE API ---
        const MaintenanceScreen = ({ errorMsg, onRetry }) => {
            const [tempKey, setTempKey] = useState('');
            return (
                <div className="fixed inset-0 bg-slate-50 z-[100] flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-slate-200 p-8 text-center animate-in">
                        <div className="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icons.Alert className="w-10 h-10 text-amber-600" />
                        </div>
                        <h1 className="text-2xl font-black text-slate-800 mb-2">Estamos em Manuten√ß√£o</h1>
                        <p className="text-slate-500 text-sm mb-6">
                            O limite da chave API padr√£o foi atingido ou o servidor est√° inst√°vel.<br/>
                            <span className="text-red-500 font-mono text-xs">Erro: {errorMsg}</span>
                        </p>
                        
                        <div className="bg-indigo-50 p-4 rounded-2xl mb-6 text-left border border-indigo-100">
                            <label className="text-xs font-bold text-indigo-700 uppercase mb-2 block">Solu√ß√£o: Use sua pr√≥pria chave</label>
                            <input 
                                type="text" 
                                value={tempKey} 
                                onChange={(e) => setTempKey(e.target.value)}
                                placeholder="Insira sua chave AIza..."
                                className="w-full p-2 rounded-lg border border-indigo-200 text-sm mb-2"
                            />
                            <button 
                                onClick={() => { localStorage.setItem('user_api_key', tempKey); onRetry(); }}
                                className="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg text-sm hover:bg-indigo-700 transition-all"
                            >
                                Salvar e Reativar Site
                            </button>
                        </div>
                        
                        <button onClick={onRetry} className="text-slate-400 hover:text-indigo-600 text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 mx-auto">
                            Tentar Reconectar Padr√£o
                        </button>
                    </div>
                </div>
            );
        };

        // --- CHAT TUTOR (MODO POPUP E FULLSCREEN) ---
        const ChatTutor = ({ currentTopic }) => {
            const [viewMode, setViewMode] = useState('closed'); // 'closed', 'popup', 'full'
            const [messages, setMessages] = useState([{ role: 'ai', text: 'Ol√°! Sou seu tutor virtual. Pergunte qualquer coisa sobre a mat√©ria!' }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, viewMode]);

            const handleSend = async () => {
                if (!input.trim() || loading) return;
                const userText = input;
                setInput('');
                setMessages(prev => [...prev, { role: 'user', text: userText }]);
                setLoading(true);

                const prompt = `Voc√™ √© um tutor acad√™mico. Assunto atual: "${currentTopic || 'Geral'}". O aluno perguntou: "${userText}". Responda com precis√£o, verifique os fatos 3 vezes antes de falar. Use Markdown.`;

                try {
                    const res = await callGemini(prompt);
                    setMessages(prev => [...prev, { role: 'ai', text: res }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'ai', text: 'Erro ao processar resposta do tutor.' }]);
                } finally { setLoading(false); }
            };

            if (viewMode === 'closed') return (
                <button onClick={() => setViewMode('popup')} className="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-xl hover:scale-110 transition-all z-50">
                    <Icons.ChatBubble className="w-6 h-6" />
                </button>
            );

            const isFull = viewMode === 'full';

            return (
                <div className={isFull ? "fixed inset-0 z-50 bg-white flex flex-col animate-in" : "fixed bottom-6 right-6 z-50 w-96 h-[500px] glass-effect rounded-2xl shadow-2xl border flex flex-col overflow-hidden animate-slide-up"}>
                    <div className="bg-indigo-600 p-4 text-white flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <Icons.Brain className="w-5 h-5" />
                            <span className="font-bold">Tutor IA {isFull && '- Modo Aula'}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setViewMode(isFull ? 'popup' : 'full')} className="p-1 hover:bg-white/20 rounded">{isFull ? <Icons.Minimize className="w-5 h-5"/> : <Icons.Maximize className="w-5 h-5"/>}</button>
                            <button onClick={() => setViewMode('closed')} className="p-1 hover:bg-white/20 rounded"><Icons.X className="w-5 h-5"/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll bg-slate-50/50">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border text-slate-800 rounded-bl-none shadow-sm'}`}>
                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(m.text) }} />
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-slate-400 italic">IA pensando...</div>}
                        <div ref={scrollRef} />
                    </div>
                    <div className="p-4 bg-white border-t flex gap-2">
                        <input value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="Sua d√∫vida..." className="flex-1 bg-slate-100 rounded-xl px-4 py-2 focus:outline-none" />
                        <button onClick={handleSend} disabled={loading} className="bg-indigo-600 text-white p-2 px-4 rounded-xl"><Icons.Send className="w-5 h-5"/></button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        function StudyGenius() {
            const [view, setView] = useState('home');
            const [maintenance, setMaintenance] = useState(null);
            const [topics, setTopics] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            // Configura√ß√µes
            const [quizConfig, setQuizConfig] = useState({ count: 5, difficulty: 'Intermedi√°rio' });
            const [flashcards, setFlashcards] = useState([]);
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [quizResults, setQuizResults] = useState(null);
            const [analysis, setAnalysis] = useState(null);

            // Interface Control
            const [currentCard, setCurrentCard] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [answers, setAnswers] = useState({});
            const [hints, setHints] = useState({});

            const handleError = (e) => {
                setLoading(false);
                if (e.message.includes('429') || e.message.includes('400') || e.message.includes('Key')) setMaintenance(e.message);
                else setError("Falha na conex√£o. Tente novamente.");
            };

            // GERAR FLASHCARDS
            const handleFlashcards = async (customTopic = null) => {
                const target = customTopic || topics;
                if (!target.trim()) return setError("Defina um t√≥pico.");
                setLoading(true); setError('');
                
                const prompt = `Gere 8 flashcards verificados sobre: "${target}". REGRAS: Revis√£o tripla de fatos. Retorne Array JSON: [{"front": "...", "back": "..."}]`;
                
                try {
                    const res = await callGemini(prompt);
                    const data = parseJSONFromAI(res);
                    if (data) { setFlashcards(data); setCurrentCard(0); setFlipped(false); setView('flashcards'); }
                } catch (e) { handleError(e); }
                finally { setLoading(false); }
            };

            // GERAR QUIZ (PRECIS√ÉO M√ÅXIMA)
            const handleQuiz = async () => {
                if (!topics.trim()) return setError("Defina um t√≥pico.");
                setLoading(true); setError('');

                const prompt = `
                    Gere um quiz com EXATAMENTE ${quizConfig.count} perguntas n√≠vel ${quizConfig.difficulty} sobre "${topics}".
                    PROTOCOLO DE QUALIDADE: 
                    1. Verifique se a resposta √© √∫nica e correta.
                    2. Explique detalhadamente a resposta correta.
                    Retorne Array JSON: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "hint": "...", "explanation": "..."}]
                `;

                try {
                    const res = await callGemini(prompt);
                    const data = parseJSONFromAI(res);
                    if (data) { setQuizQuestions(data); setAnswers({}); setHints({}); setView('quiz'); }
                } catch (e) { handleError(e); }
                finally { setLoading(false); }
            };

            const submitQuiz = async () => {
                let score = 0;
                const report = quizQuestions.map((q, i) => {
                    const correct = answers[i] === q.correctIndex;
                    if (correct) score++;
                    return { q: q.question, correct, user: q.options[answers[i]], correctAns: q.options[q.correctIndex], explanation: q.explanation };
                });
                setQuizResults({ score, total: quizQuestions.length, report });
                setLoading(true);

                const prompt = `Analise este desempenho em "${topics}": ${score}/${quizQuestions.length}. JSON: {"feedback": "...", "weakPoints": ["..."], "studyPlan": "..."}`;
                try {
                    const res = await callGemini(prompt);
                    setAnalysis(parseJSONFromAI(res));
                    setView('analysis');
                } catch (e) { handleError(e); }
                finally { setLoading(false); }
            };

            const downloadReport = () => {
                const text = `ESTUDO: ${topics}\nSCORE: ${quizResults.score}/${quizResults.total}\n\nFEEDBACK:\n${analysis.feedback}\n\nPLANO:\n${analysis.studyPlan}`;
                const blob = new Blob([text], {type: 'text/plain'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio-${topics}.txt`;
                a.click();
            };

            if (maintenance) return <MaintenanceScreen errorMsg={maintenance} onRetry={() => setMaintenance(null)} />;

            return (
                <div className="min-h-screen pb-20">
                    {loading && (
                        <div className="fixed inset-0 bg-white/90 z-[90] flex flex-col items-center justify-center backdrop-blur-sm animate-in">
                            <Icons.Loader className="w-12 h-12 text-indigo-600 animate-spin mb-4" />
                            <p className="text-indigo-900 font-bold">IA Estudando para voc√™...</p>
                        </div>
                    )}

                    <header className="h-16 border-b bg-white flex items-center px-6 sticky top-0 z-40">
                        <div className="max-w-5xl mx-auto w-full flex justify-between items-center">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}>
                                <div className="bg-indigo-600 p-1.5 rounded-lg text-white"><Icons.Book className="w-5 h-5" /></div>
                                <span className="font-bold text-xl">StudyGenius <span className="text-xs bg-indigo-100 text-indigo-600 px-2 rounded-full">PRO</span></span>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4">
                        {view === 'home' && (
                            <div className="py-10 space-y-8 animate-in">
                                <div className="text-center">
                                    <h2 className="text-5xl font-black text-slate-800 mb-2">Seu Mentor de IA</h2>
                                    <p className="text-slate-500">Aprenda qualquer assunto com precis√£o cient√≠fica.</p>
                                </div>
                                <div className="bg-white p-6 rounded-3xl shadow-xl border border-indigo-50">
                                    <textarea value={topics} onChange={(e) => setTopics(e.target.value)} placeholder="O que voc√™ quer estudar hoje? (Ex: Ciclo de Krebs)" className="w-full h-32 p-4 rounded-xl border focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all text-lg mb-4" />
                                    <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                                        <div>
                                            <label className="text-[10px] font-black uppercase text-slate-400">Quest√µes</label>
                                            <select value={quizConfig.count} onChange={e => setQuizConfig({...quizConfig, count: parseInt(e.target.value)})} className="w-full p-2 bg-slate-50 rounded-lg font-bold border">
                                                <option value={5}>5 Quest√µes</option><option value={10}>10 Quest√µes</option><option value={15}>15 Quest√µes</option><option value={20}>20 Quest√µes</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black uppercase text-slate-400">N√≠vel</label>
                                            <select value={quizConfig.difficulty} onChange={e => setQuizConfig({...quizConfig, difficulty: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg font-bold border">
                                                <option value="Iniciante">Iniciante</option><option value="Intermedi√°rio">Intermedi√°rio</option><option value="Avan√ßado">Avan√ßado</option>
                                            </select>
                                        </div>
                                    </div>
                                    {error && <p className="text-red-500 text-center font-bold mt-4 bg-red-50 p-2 rounded">{error}</p>}
                                </div>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <button onClick={() => handleFlashcards()} className="p-6 bg-white border-2 border-indigo-100 rounded-2xl flex items-center justify-center gap-4 font-bold text-slate-700 hover:border-indigo-500 hover:bg-indigo-50 transition-all"><Icons.Book className="text-indigo-600 w-7 h-7" /> Flashcards</button>
                                    <button onClick={handleQuiz} className="p-6 bg-white border-2 border-blue-100 rounded-2xl flex items-center justify-center gap-4 font-bold text-slate-700 hover:border-blue-500 hover:bg-blue-50 transition-all"><Icons.Brain className="text-blue-600 w-7 h-7" /> Iniciar Quiz</button>
                                </div>
                            </div>
                        )}

                        {view === 'flashcards' && (
                            <div className="py-10 flex flex-col items-center gap-8 animate-in">
                                <div className="w-full flex justify-between items-center">
                                    <button onClick={() => setView('home')} className="text-slate-400 hover:text-indigo-600 font-bold flex items-center gap-2"><Icons.ArrowLeft className="w-5 h-5"/> Voltar</button>
                                    <span className="bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full text-xs font-bold uppercase">{currentCard + 1} / {flashcards.length}</span>
                                </div>
                                <div className="w-full max-w-lg aspect-[3/2] perspective-1000 cursor-pointer" onClick={() => setFlipped(!flipped)}>
                                    <div className={`relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl ${flipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 bg-white rounded-3xl p-10 flex flex-col items-center justify-center backface-hidden border text-center"><p className="text-2xl font-bold">{flashcards[currentCard].front}</p></div>
                                        <div className="absolute inset-0 bg-indigo-600 text-white rounded-3xl p-10 flex flex-col items-center justify-center backface-hidden rotate-y-180 text-center"><p className="text-xl font-medium">{flashcards[currentCard].back}</p></div>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <button disabled={currentCard===0} onClick={() => {setCurrentCard(c=>c-1); setFlipped(false)}} className="p-4 bg-white rounded-full shadow disabled:opacity-30"><Icons.ArrowLeft className="w-6 h-6"/></button>
                                    <button onClick={() => setFlipped(!flipped)} className="px-10 bg-slate-800 text-white rounded-full font-bold">Virar</button>
                                    <button disabled={currentCard===flashcards.length-1} onClick={() => {setCurrentCard(c=>c+1); setFlipped(false)}} className="p-4 bg-white rounded-full shadow disabled:opacity-30"><Icons.ArrowRight className="w-6 h-6"/></button>
                                </div>
                            </div>
                        )}

                        {view === 'quiz' && (
                            <div className="py-10 pb-24 animate-in space-y-6">
                                <button onClick={() => setView('home')} className="text-slate-400 hover:text-red-500 font-bold flex gap-2"><Icons.ArrowLeft className="w-5 h-5"/> Cancelar</button>
                                {quizQuestions.map((q, i) => (
                                    <div key={i} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <h3 className="font-bold text-lg mb-4 flex gap-3"><span className="bg-slate-100 w-8 h-8 flex items-center justify-center rounded text-sm">{i+1}</span>{q.question}</h3>
                                        <div className="grid gap-2 pl-11">
                                            {q.options.map((opt, oIdx) => (
                                                <button key={oIdx} onClick={() => setAnswers({...answers, [i]: oIdx})} className={`text-left p-3 rounded-xl border transition-all ${answers[i] === oIdx ? 'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold shadow-sm' : 'hover:bg-slate-50'}`}>{opt}</button>
                                            ))}
                                        </div>
                                        <div className="ml-11 mt-4">
                                            {!hints[i] ? <button onClick={() => setHints({...hints, [i]: true})} className="text-xs font-bold text-amber-500 flex items-center gap-1 hover:text-amber-600 transition-colors"><Icons.Lightbulb className="w-4 h-4" /> Ver Dica</button> : <p className="text-sm bg-amber-50 p-3 rounded-lg text-amber-800 border border-amber-100">üí° {q.hint}</p>}
                                        </div>
                                    </div>
                                ))}
                                <div className="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur border-t p-4 flex justify-center z-40">
                                    <button onClick={submitQuiz} disabled={Object.keys(answers).length !== quizQuestions.length} className="bg-green-600 text-white font-bold py-3 px-12 rounded-2xl shadow-xl hover:bg-green-700 disabled:opacity-40 transition-all flex items-center gap-2">
                                        {loading ? <Icons.Loader className="animate-spin w-5 h-5"/> : <Icons.Check className="w-5 h-5"/>} Finalizar Quiz
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'analysis' && (
                            <div className="py-10 animate-in space-y-8 pb-10">
                                <div className="text-center">
                                    <h2 className="text-3xl font-black">Seu Desempenho</h2>
                                    <div className="text-6xl font-black text-indigo-600 my-2">{quizResults.score} <span className="text-2xl text-slate-300">/ {quizResults.total}</span></div>
                                </div>
                                <div className="bg-indigo-600 p-8 rounded-3xl text-white shadow-xl relative overflow-hidden">
                                    <h3 className="font-bold text-xl mb-4 flex items-center gap-2"><Icons.Brain className="w-6 h-6"/> Mentor IA</h3>
                                    <p className="relative z-10 text-indigo-50 leading-relaxed">{analysis.feedback}</p>
                                    <div className="absolute top-0 right-0 p-10 opacity-10"><Icons.Brain className="w-32 h-32"/></div>
                                </div>
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-2xl border shadow-sm">
                                        <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2 text-red-500"><Icons.X className="w-5 h-5"/> Onde Melhorar</h4>
                                        <ul className="space-y-2">{analysis.weakPoints.map((p,i) => <li key={i} className="text-sm text-slate-600 flex gap-2"><span className="w-1.5 h-1.5 bg-red-400 rounded-full mt-2 shrink-0"></span> {p}</li>)}</ul>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl border shadow-sm">
                                        <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2 text-green-500"><Icons.Check className="w-5 h-5"/> Plano de A√ß√£o</h4>
                                        <p className="text-sm text-slate-600">{analysis.studyPlan}</p>
                                    </div>
                                </div>
                                <div className="flex justify-center gap-4">
                                    <button onClick={downloadReport} className="flex items-center gap-2 text-indigo-600 font-bold border-2 border-indigo-100 px-6 py-2 rounded-xl hover:bg-indigo-50 transition-all"><Icons.Download className="w-5 h-5"/> Relat√≥rio</button>
                                    <button onClick={() => { setView('home'); setTopics(''); }} className="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-900 transition-all shadow-lg">Novo Assunto</button>
                                </div>
                                <div className="pt-10 space-y-4">
                                    <h3 className="font-bold text-xl border-b pb-2">Revis√£o do Quiz</h3>
                                    {quizResults.report.map((r, i) => (
                                        <div key={i} className={`p-5 rounded-2xl border-l-8 bg-white shadow-sm ${r.correct ? 'border-green-500' : 'border-red-500'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <p className="font-bold text-slate-800">{i+1}. {r.q}</p>
                                                {r.correct ? <span className="text-green-600 font-black text-xs uppercase">Correto</span> : <span className="text-red-600 font-black text-xs uppercase">Errado</span>}
                                            </div>
                                            <div className="text-sm space-y-1 bg-slate-50 p-3 rounded-lg">
                                                <p>Sua: <span className={r.correct ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}>{r.user}</span></p>
                                                {!r.correct && <p>Correta: <span className="text-green-600 font-bold">{r.correctAns}</span></p>}
                                                <p className="mt-2 text-slate-500 text-xs italic"><b>Por que?</b> {r.explanation}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <ChatTutor currentTopic={topics} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudyGenius />);
    </script>
</body>
</html>
