<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyGenius Pro - Estudo Inteligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Marked para Markdown no Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-zoom { animation: zoomIn 0.2s ease-out forwards; }

        /* Scrollbar personalizada */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CHAVE DA API ---
        const API_KEY = "AIzaSyBo-HKscY9Pbfiygi3Pu6ElRgi0QgbhxfQ";

        // --- √çcones SVG ---
        const Icon = ({ d, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );

        const Icons = {
            Book: (props) => <Icon {...props} d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />,
            Brain: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Lightbulb: (props) => <Icon {...props} d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.8-6-6-6S6 4.8 6 8c0 1.4.5 2.8 1.5 3.8.8.8 1.3 1.5 1.5 2.5 M9 18h6 M10 22h4" />,
            Check: (props) => <Icon {...props} d="M20 6L9 17l-5-5" />,
            X: (props) => <Icon {...props} d="M18 6L6 18M6 6l12 12" />,
            ArrowRight: (props) => <Icon {...props} d="M5 12h14M12 5l7 7-7 7" />,
            ArrowLeft: (props) => <Icon {...props} d="M19 12H5M12 19l-7-7 7-7" />,
            Loader: (props) => <Icon {...props} d="M21 12a9 9 0 1 1-6.219-8.56" />,
            ChatBubble: (props) => <Icon {...props} d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />,
            Send: (props) => <Icon {...props} d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />,
            Maximize: (props) => <Icon {...props} d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />,
            Minimize: (props) => <Icon {...props} d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7" />,
            Download: (props) => <Icon {...props} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            Settings: (props) => <Icon {...props} d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" /> // Simplified settings icon
        };

        // --- Fun√ß√µes da API ---
        const callGemini = async (prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                console.error("Erro API:", error);
                throw error;
            }
        };

        const parseJSONFromAI = (text) => {
            try {
                const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```([\s\S]*?)```/);
                return JSON.parse(jsonMatch ? jsonMatch[1] : text);
            } catch (e) { return null; }
        };

        // --- Componente Chat Tutor (Popup e Fullscreen) ---
        const ChatTutor = ({ currentTopic }) => {
            const [viewMode, setViewMode] = useState('closed'); // 'closed', 'popup', 'full'
            const [messages, setMessages] = useState([
                { role: 'ai', text: 'Ol√°! Sou seu tutor virtual. Se tiver d√∫vida sobre o conte√∫do, √© s√≥ perguntar aqui!' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
            };

            useEffect(scrollToBottom, [messages, viewMode]);

            const handleSend = async () => {
                if (!input.trim() || loading) return;
                
                const userText = input;
                setInput('');
                setMessages(prev => [...prev, { role: 'user', text: userText }]);
                setLoading(true);

                const prompt = `
                    Voc√™ √© um tutor paciente e did√°tico ajudando um aluno que est√° estudando sobre: "${currentTopic || 'Geral'}".
                    O aluno perguntou: "${userText}"
                    Responda de forma clara, concisa e encorajadora. Use formata√ß√£o Markdown (negrito, listas) se necess√°rio.
                `;

                try {
                    const aiResponse = await callGemini(prompt);
                    setMessages(prev => [...prev, { role: 'ai', text: aiResponse }]);
                } catch (e) {
                    setMessages(prev => [...prev, { role: 'ai', text: 'Ops, tive um problema de conex√£o. Tente novamente.' }]);
                } finally {
                    setLoading(false);
                }
            };

            // Se estiver fechado, mostra s√≥ o bot√£o
            if (viewMode === 'closed') {
                return (
                    <div className="fixed bottom-6 right-6 z-50">
                        <button 
                            onClick={() => setViewMode('popup')}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg shadow-indigo-500/30 transition-all hover:scale-110 active:scale-95 flex items-center justify-center gap-2 group"
                        >
                            <Icons.ChatBubble className="w-6 h-6" />
                            <span className="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 font-bold whitespace-nowrap">Tutor IA</span>
                        </button>
                    </div>
                );
            }

            // Classes baseadas no modo (Popup vs Full)
            const containerClasses = viewMode === 'full' 
                ? "fixed inset-0 z-50 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 animate-in"
                : "fixed bottom-6 right-6 z-50 w-80 sm:w-96 h-[500px] animate-slide-up bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden";
            
            const innerClasses = viewMode === 'full'
                ? "w-full max-w-4xl h-full max-h-[90vh] bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden"
                : "w-full h-full flex flex-col";

            return (
                <div className={containerClasses}>
                    <div className={innerClasses}>
                        {/* Header Chat */}
                        <div className="bg-indigo-600 p-4 flex justify-between items-center text-white shrink-0">
                            <div className="flex items-center gap-2">
                                <Icons.Brain className="w-6 h-6" />
                                <div>
                                    <span className="font-bold block leading-none">Tutor IA</span>
                                    <span className="text-xs text-indigo-200 opacity-80">{currentTopic ? (currentTopic.length > 20 ? currentTopic.substring(0,20)+'...' : currentTopic) : 'Geral'}</span>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setViewMode(viewMode === 'full' ? 'popup' : 'full')} 
                                    className="hover:bg-indigo-500 p-1.5 rounded transition-colors"
                                    title={viewMode === 'full' ? "Minimizar" : "Expandir"}
                                >
                                    {viewMode === 'full' ? <Icons.Minimize className="w-5 h-5" /> : <Icons.Maximize className="w-5 h-5" />}
                                </button>
                                <button onClick={() => setViewMode('closed')} className="hover:bg-indigo-500 p-1.5 rounded transition-colors">
                                    <Icons.X className="w-5 h-5" />
                                </button>
                            </div>
                        </div>

                        {/* √Årea de Mensagens */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 custom-scroll">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${
                                        m.role === 'user' 
                                        ? 'bg-indigo-600 text-white rounded-br-none shadow-md' 
                                        : 'bg-white text-gray-800 rounded-bl-none border border-gray-200 shadow-sm prose prose-sm max-w-none'
                                    }`}>
                                        <div dangerouslySetInnerHTML={{ __html: marked.parse(m.text) }} />
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex justify-start">
                                    <div className="bg-white p-3 rounded-2xl rounded-bl-none border border-gray-200 text-gray-400 text-xs italic flex items-center gap-2">
                                        <Icons.Loader className="w-3 h-3 animate-spin" /> Digitando...
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white border-t border-gray-100 flex gap-2 shrink-0">
                            <input 
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Tire sua d√∫vida..." 
                                className="flex-1 bg-gray-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800"
                            />
                            <button 
                                onClick={handleSend}
                                disabled={loading || !input.trim()}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-xl transition-colors disabled:opacity-50"
                            >
                                <Icons.Send className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal ---
        function StudyGenius() {
            const [view, setView] = useState('home');
            const [topics, setTopics] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Configura√ß√µes do Quiz
            const [quizConfig, setQuizConfig] = useState({
                count: 5,
                difficulty: 'Intermedi√°rio'
            });
            
            // Dados
            const [flashcards, setFlashcards] = useState([]);
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [quizResults, setQuizResults] = useState(null);
            const [analysis, setAnalysis] = useState(null);

            // Controle
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [quizAnswers, setQuizAnswers] = useState({});
            const [hintsRevealed, setHintsRevealed] = useState({});

            // Gera√ß√£o de Flashcards
            const handleGenerateFlashcards = async (customTopic = null) => {
                const topicToUse = customTopic || topics;
                if (!topicToUse.trim()) { setError("Digite um t√≥pico para come√ßar."); return; }
                setLoading(true); setError('');

                const prompt = `Crie 8 flashcards did√°ticos sobre: "${topicToUse}". Retorne APENAS Array JSON: [{"front": "Pergunta", "back": "Resposta"}]`;

                try {
                    const text = await callGemini(prompt);
                    const data = parseJSONFromAI(text);
                    if (data) {
                        setFlashcards(data);
                        setCurrentCardIndex(0);
                        setIsFlipped(false);
                        setView('flashcards');
                    } else throw new Error("Falha ao gerar dados.");
                } catch (err) { setError("Erro ao conectar. Tente novamente."); }
                finally { setLoading(false); }
            };

            // Gera√ß√£o de Quiz (Com Configura√ß√£o)
            const handleGenerateQuiz = async () => {
                if (!topics.trim()) { setError("Digite um t√≥pico primeiro."); return; }
                setLoading(true); setError('');

                const prompt = `
                    Crie um quiz com EXATAMENTE ${quizConfig.count} perguntas de n√≠vel ${quizConfig.difficulty} sobre: "${topics}". 
                    Retorne APENAS Array JSON: [{"question": "...", "options": ["A","B","C","D"], "correctIndex": 0, "hint": "...", "explanation": "..."}]
                `;

                try {
                    const text = await callGemini(prompt);
                    const data = parseJSONFromAI(text);
                    if (data && Array.isArray(data)) {
                        setQuizQuestions(data);
                        setQuizAnswers({});
                        setHintsRevealed({});
                        setQuizResults(null);
                        setView('quiz');
                    } else throw new Error("Falha ao gerar quiz.");
                } catch (err) { setError("Erro ao conectar. Tente novamente."); }
                finally { setLoading(false); }
            };

            // Submiss√£o de Quiz
            const handleSubmitQuiz = async () => {
                let score = 0;
                const report = quizQuestions.map((q, idx) => {
                    const isCorrect = quizAnswers[idx] === q.correctIndex;
                    if (isCorrect) score++;
                    return { 
                        q: q.question, 
                        correct: isCorrect, 
                        userAns: q.options[quizAnswers[idx]],
                        correctAns: q.options[q.correctIndex] 
                    };
                });
                
                setQuizResults({ score, total: quizQuestions.length, report });
                setLoading(true);

                const prompt = `Analise este resultado de quiz sobre "${topics}": ${score}/${quizQuestions.length} acertos. Erros: ${JSON.stringify(report.filter(r => !r.correct))}. Retorne JSON: {"feedback": "...", "weakPoints": ["T√≥pico 1", "T√≥pico 2"], "studyPlan": "..."}`;

                try {
                    const text = await callGemini(prompt);
                    setAnalysis(parseJSONFromAI(text));
                    setView('analysis');
                } catch (err) { setError("Erro na an√°lise."); }
                finally { setLoading(false); }
            };

            // Exportar Resultado
            const downloadReport = () => {
                if (!analysis) return;
                const content = `
RELAT√ìRIO DE ESTUDOS - STUDYGENIUS
----------------------------------
T√≥pico: ${topics}
Nota: ${quizResults.score}/${quizResults.total}

FEEDBACK:
${analysis.feedback}

PONTOS A MELHORAR:
${analysis.weakPoints.map(p => `- ${p}`).join('\n')}

PLANO DE ESTUDO:
${analysis.studyPlan}
                `;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Estudo-${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
            };

            // --- Views ---

            const renderHome = () => (
                <div className="max-w-3xl mx-auto space-y-8 animate-in py-10">
                    <div className="text-center space-y-4">
                        <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500 pb-2">
                        StudyGenius
                        </h1>
                        <p className="text-slate-500 text-xl font-medium">Configure seu estudo e aprenda qualquer coisa.</p>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-xl shadow-indigo-100 border border-indigo-50">
                        <textarea
                            value={topics}
                            onChange={(e) => setTopics(e.target.value)}
                            placeholder="Ex: F√≠sica Qu√¢ntica, Hist√≥ria do Brasil, Verbos em Ingl√™s..."
                            className="w-full h-32 p-4 rounded-xl border border-slate-200 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 focus:outline-none resize-none transition-all text-lg text-slate-800 placeholder-slate-400 mb-4"
                        />
                        
                        {/* Configura√ß√µes do Quiz */}
                        <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Qtd. Quest√µes</label>
                                <select 
                                    value={quizConfig.count}
                                    onChange={(e) => setQuizConfig({...quizConfig, count: parseInt(e.target.value)})}
                                    className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    <option value={5}>5 Quest√µes</option>
                                    <option value={10}>10 Quest√µes</option>
                                    <option value={15}>15 Quest√µes</option>
                                    <option value={20}>20 Quest√µes</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Dificuldade</label>
                                <select 
                                    value={quizConfig.difficulty}
                                    onChange={(e) => setQuizConfig({...quizConfig, difficulty: e.target.value})}
                                    className="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    <option value="Iniciante">Iniciante</option>
                                    <option value="Intermedi√°rio">Intermedi√°rio</option>
                                    <option value="Avan√ßado">Avan√ßado</option>
                                </select>
                            </div>
                        </div>

                        {error && <p className="text-red-500 text-sm mt-4 font-bold bg-red-50 p-2 rounded-lg text-center">{error}</p>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onClick={() => handleGenerateFlashcards()} className="flex items-center justify-center gap-3 p-5 bg-white border-2 border-indigo-100 hover:border-indigo-500 hover:bg-indigo-50 rounded-2xl transition-all group shadow-sm">
                            <div className="bg-indigo-100 p-2 rounded-xl group-hover:bg-indigo-200 transition-colors"><Icons.Book className="w-6 h-6 text-indigo-600" /></div>
                            <span className="font-bold text-slate-700 text-lg">Criar Flashcards</span>
                        </button>

                        <button onClick={handleGenerateQuiz} className="flex items-center justify-center gap-3 p-5 bg-white border-2 border-blue-100 hover:border-blue-500 hover:bg-blue-50 rounded-2xl transition-all group shadow-sm">
                            <div className="bg-blue-100 p-2 rounded-xl group-hover:bg-blue-200 transition-colors"><Icons.Brain className="w-6 h-6 text-blue-600" /></div>
                            <div className="text-left">
                                <span className="font-bold text-slate-700 text-lg block leading-none">Gerar Quiz</span>
                                <span className="text-xs text-slate-400 font-medium">{quizConfig.count} perguntas ‚Ä¢ {quizConfig.difficulty}</span>
                            </div>
                        </button>
                    </div>
                </div>
            );

            const renderFlashcards = () => (
                <div className="max-w-xl mx-auto h-full flex flex-col items-center justify-center space-y-8 py-10">
                    <div className="w-full flex justify-between items-center">
                        <button onClick={() => setView('home')} className="text-slate-400 hover:text-indigo-600 flex items-center gap-2 font-bold transition-colors">
                            <Icons.ArrowLeft className="w-5 h-5" /> Voltar
                        </button>
                        <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold tracking-wider">
                            CARD {currentCardIndex + 1} / {flashcards.length}
                        </span>
                    </div>

                    <div className="w-full aspect-[3/2] perspective-1000 cursor-pointer group" onClick={() => setIsFlipped(!isFlipped)}>
                        <div className={`relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl shadow-indigo-200/50 rounded-3xl ${isFlipped ? 'rotate-y-180' : ''}`}>
                            <div className="absolute inset-0 bg-white rounded-3xl p-8 flex flex-col items-center justify-center backface-hidden border border-indigo-50">
                                <span className="text-xs font-black text-indigo-400 uppercase tracking-widest mb-4">Conceito</span>
                                <p className="text-2xl font-bold text-center text-slate-800">{flashcards[currentCardIndex].front}</p>
                                <p className="absolute bottom-6 text-slate-300 text-sm">Toque para virar</p>
                            </div>
                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 to-blue-600 text-white rounded-3xl p-8 flex flex-col items-center justify-center backface-hidden rotate-y-180">
                                <span className="text-xs font-black text-indigo-200 uppercase tracking-widest mb-4">Explica√ß√£o</span>
                                <p className="text-xl font-medium text-center">{flashcards[currentCardIndex].back}</p>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-4">
                        <button onClick={() => { if(currentCardIndex>0){ setCurrentCardIndex(c=>c-1); setIsFlipped(false); } }} disabled={currentCardIndex===0} className="p-4 bg-white rounded-full shadow-lg disabled:opacity-50 hover:bg-slate-50 transition-all"><Icons.ArrowLeft className="w-6 h-6" /></button>
                        <button onClick={() => setIsFlipped(!isFlipped)} className="px-8 bg-slate-800 text-white rounded-full font-bold shadow-lg hover:bg-slate-900 transition-all">Virar</button>
                        <button onClick={() => { if(currentCardIndex<flashcards.length-1){ setCurrentCardIndex(c=>c+1); setIsFlipped(false); } }} disabled={currentCardIndex===flashcards.length-1} className="p-4 bg-white rounded-full shadow-lg disabled:opacity-50 hover:bg-slate-50 transition-all"><Icons.ArrowRight className="w-6 h-6" /></button>
                    </div>
                </div>
            );

            const renderQuiz = () => (
                <div className="max-w-2xl mx-auto pb-24 py-10">
                    <div className="flex items-center justify-between mb-8">
                        <button onClick={() => setView('home')} className="text-slate-400 hover:text-red-500 flex items-center gap-2 font-bold transition-colors">
                            <Icons.ArrowLeft className="w-5 h-5" /> Cancelar
                        </button>
                        <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Progresso: {Object.keys(quizAnswers).length} / {quizQuestions.length}
                        </div>
                    </div>

                    <div className="space-y-6">
                        {quizQuestions.map((q, idx) => (
                            <div key={idx} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex gap-3">
                                    <span className="bg-slate-100 text-slate-600 w-7 h-7 flex items-center justify-center rounded-lg text-sm shrink-0">{idx + 1}</span>
                                    {q.question}
                                </h3>
                                <div className="grid gap-3 ml-10">
                                    {q.options.map((opt, optIdx) => (
                                        <button 
                                            key={optIdx} 
                                            onClick={() => setQuizAnswers(prev => ({...prev, [idx]: optIdx}))}
                                            className={`text-left px-4 py-3 rounded-xl border transition-all font-medium ${
                                                quizAnswers[idx] === optIdx 
                                                ? 'bg-indigo-50 border-indigo-500 text-indigo-700 shadow-sm' 
                                                : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'
                                            }`}
                                        >
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                                <div className="ml-10 mt-4">
                                    {!hintsRevealed[idx] ? (
                                        <button onClick={() => setHintsRevealed(p => ({...p, [idx]: true}))} className="text-xs font-bold text-amber-500 flex items-center gap-1 hover:text-amber-600 transition-colors">
                                            <Icons.Lightbulb className="w-4 h-4" /> Ver Dica
                                        </button>
                                    ) : (
                                        <div className="bg-amber-50 p-3 rounded-lg text-sm text-amber-800 border border-amber-100 animate-in">
                                            üí° {q.hint}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-0 left-0 w-full bg-white border-t p-4 z-10 flex justify-center">
                        <button onClick={handleSubmitQuiz} disabled={Object.keys(quizAnswers).length !== quizQuestions.length} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-xl shadow-xl disabled:opacity-50 disabled:grayscale transition-all flex items-center gap-2">
                            {loading ? <Icons.Loader className="w-5 h-5 animate-spin" /> : <Icons.Check className="w-5 h-5" />} Finalizar Quiz
                        </button>
                    </div>
                </div>
            );

            const renderAnalysis = () => (
                <div className="max-w-3xl mx-auto space-y-8 animate-in py-10 pb-20">
                    <div className="text-center">
                        <h2 className="text-3xl font-black text-slate-800">Resultado</h2>
                        <div className="text-5xl font-black text-indigo-600 mt-2">{quizResults?.score} / {quizResults?.total}</div>
                    </div>

                    <div className="bg-white p-8 rounded-3xl border border-indigo-100 shadow-xl relative overflow-hidden">
                        <div className="relative z-10">
                            <h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2"><Icons.Brain className="w-5 h-5" /> Feedback</h3>
                            <p className="text-indigo-800 leading-relaxed">{analysis?.feedback}</p>
                        </div>
                        <div className="absolute top-0 right-0 p-8 opacity-5"><Icons.Brain className="w-40 h-40" /></div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="bg-red-50 p-6 rounded-2xl border border-red-100">
                            <h3 className="font-bold text-red-700 mb-4 flex items-center gap-2"><Icons.X className="w-5 h-5" /> Pontos a Melhorar</h3>
                            <ul className="space-y-2">
                                {analysis?.weakPoints?.map((pt, i) => (
                                    <li key={i} className="flex gap-2 text-red-900 text-sm"><span className="mt-1.5 w-1.5 h-1.5 bg-red-400 rounded-full shrink-0"></span>{pt}</li>
                                ))}
                            </ul>
                        </div>
                        <div className="bg-green-50 p-6 rounded-2xl border border-green-100">
                            <h3 className="font-bold text-green-700 mb-4 flex items-center gap-2"><Icons.Book className="w-5 h-5" /> Plano de Estudo</h3>
                            <p className="text-green-900 text-sm leading-relaxed">{analysis?.studyPlan}</p>
                        </div>
                    </div>

                    <div className="flex justify-center">
                         <button 
                            onClick={downloadReport}
                            className="flex items-center gap-2 text-indigo-600 font-bold hover:bg-indigo-50 px-4 py-2 rounded-lg transition-colors border border-indigo-200"
                        >
                            <Icons.Download className="w-5 h-5" /> Baixar Resumo (.txt)
                        </button>
                    </div>
                    
                    {/* --- GABARITO --- */}
                    <div className="space-y-4 pt-6">
                        <h3 className="text-2xl font-bold text-slate-800 border-b pb-2">Revis√£o Detalhada</h3>
                        <div className="grid gap-4">
                            {quizResults?.report?.map((item, idx) => (
                                <div key={idx} className={`p-5 rounded-2xl border-l-4 shadow-sm bg-white ${item.correct ? 'border-green-500' : 'border-red-500'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <p className="font-bold text-slate-800 text-lg">Quest√£o {idx + 1}</p>
                                        {item.correct 
                                            ? <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Icons.Check className="w-3 h-3" /> Correto</span>
                                            : <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Icons.X className="w-3 h-3" /> Incorreto</span>
                                        }
                                    </div>
                                    <p className="text-slate-600 font-medium mb-3">{item.q}</p>
                                    
                                    <div className="text-sm space-y-2 bg-slate-50 p-3 rounded-lg">
                                        <p>
                                            <span className="text-slate-500 block text-xs uppercase font-bold">Sua resposta</span>
                                            <span className={`font-bold ${item.correct ? 'text-green-600' : 'text-red-600'}`}>{item.userAns}</span>
                                        </p>
                                        {!item.correct && (
                                            <p>
                                                <span className="text-slate-500 block text-xs uppercase font-bold">Resposta Correta</span>
                                                <span className="font-bold text-green-600">{item.correctAns}</span>
                                            </p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-center gap-4 pt-4">
                        <button onClick={() => handleGenerateFlashcards(analysis?.weakPoints?.join(", "))} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all">Praticar Erros</button>
                        <button onClick={() => { setTopics(''); setView('home'); }} className="bg-white text-slate-700 px-6 py-3 rounded-xl font-bold border hover:bg-slate-50 transition-all">Novo Assunto</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    {loading && (
                        <div className="fixed inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center animate-in backdrop-blur-sm">
                            <Icons.Loader className="w-12 h-12 text-indigo-600 animate-spin mb-4" />
                            <p className="text-indigo-900 font-bold animate-pulse">A IA est√° criando seu material...</p>
                        </div>
                    )}

                    <header className="bg-white border-b sticky top-0 z-20 h-16 flex items-center">
                        <div className="max-w-5xl mx-auto px-4 w-full flex justify-between items-center">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}>
                                <div className="bg-indigo-600 p-1.5 rounded-lg"><Icons.Book className="w-5 h-5 text-white" /></div>
                                <span className="font-bold text-xl text-slate-800">StudyGenius <span className="text-indigo-600 text-xs bg-indigo-50 px-2 py-0.5 rounded-full align-middle">PRO</span></span>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto px-4">
                        {view === 'home' && renderHome()}
                        {view === 'flashcards' && renderFlashcards()}
                        {view === 'quiz' && renderQuiz()}
                        {view === 'analysis' && renderAnalysis()}
                    </main>

                    {/* Chat Tutor Global */}
                    <ChatTutor currentTopic={topics} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudyGenius />);
    </script>
</body>
</html>
